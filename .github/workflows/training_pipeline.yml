name: training-pipeline

on:
  workflow_run:
    workflows: ["feature-pipeline"]
    types:
      - completed
  # Executes every Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allows manual execution via GitHub Actions UI
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.9"

jobs:
  training_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Sets up the Python interpreter required by the project.
      # This value must remain aligned with the `requires-python` field in pyproject.toml.
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Installs uv â€” a modern, high-performance tool for dependency resolution,
      # virtual environment management, and command execution.
      #
      # Important: uv implements its own efficient caching strategy. Unlike Poetry,
      # there is no need to manually configure caching layers for ~/.cache or ~/.local.
      - name: Install uv
        uses: astral-sh/setup-uv@v2

      # Synchronizes all project dependencies defined in pyproject.toml.
      #
      # --all-extras installs optional dependency groups.
      # --group dev ensures development tools (ruff, pytest, etc.) are available
      #   when running formatting, linting, or tests in this workflow.
      #
      # uv detects and updates the virtual environment incrementally,
      # providing significantly faster installs compared to Poetry.
      - name: Sync dependencies
        run: uv sync --all-extras --group dev

      # Executes the training pipeline using the Makefile target already migrated to uv.
      # uv run ensures the script is executed inside the resolved environment.
      #
      # All sensitive credentials are injected through GitHub Secrets to avoid
      # storing confidential data in the repository.
      - name: Run training script
        env:
          HOPSWORKS_PROJECT_NAME: ${{ secrets.HOPSWORKS_PROJECT_NAME }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMET_ML_API_KEY: ${{ secrets.COMET_ML_API_KEY }}
          COMET_ML_WORKSPACE: ${{ secrets.COMET_ML_WORKSPACE }}
          COMET_ML_PROJECT_NAME: ${{ secrets.COMET_ML_PROJECT_NAME }}
        run: uv run make training
